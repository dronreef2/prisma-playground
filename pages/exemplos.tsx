import React, { useState, useEffect } from 'react'
import { createSession, executeQuery } from '../src/services/api-service'

interface User {
  id: number
  name: string
  email: string
  bio?: string
  createdAt: string
  updatedAt: string
}

export default function Exemplos() {
  const [sessionId, setSessionId] = useState<string | null>(null)
  const [users, setUsers] = useState<User[]>([])
  const [isLoading, setIsLoading] = useState(false)
  const [result, setResult] = useState<any>(null)
  const [newUserData, setNewUserData] = useState({
    name: '',
    email: '',
    bio: ''
  })

  // Iniciar sess√£o automaticamente
  useEffect(() => {
    initSession()
  }, [])

  const initSession = async () => {
    try {
      setIsLoading(true)
      const response = await fetch('/api/session/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      })
      const data = await response.json()
      if (data.success) {
        setSessionId(data.sessionId)
        console.log('‚úÖ Sess√£o iniciada:', data.sessionId)
      }
    } catch (error) {
      console.error('‚ùå Erro ao iniciar sess√£o:', error)
    } finally {
      setIsLoading(false)
    }
  }

  // Consultar todos os usu√°rios
  const consultarUsuarios = async () => {
    if (!sessionId) return
    
    try {
      setIsLoading(true)
      const query = `
        const todosUsuarios = await prisma.user.findMany({
          orderBy: { createdAt: 'desc' }
        })      console.log('todosUsuarios', todosUsuarios)
      `
      
      const response = await executeQuery(sessionId, query, true)
      if (response.success && response.result) {
        setUsers(Array.isArray(response.result) ? response.result : [])
        setResult(response.result)
      }    } catch (error: any) {
      console.error('‚ùå Erro ao consultar usu√°rios:', error)
      setResult({ error: error?.message || 'Erro desconhecido' })
    } finally {
      setIsLoading(false)
    }
  }

  // Criar novo usu√°rio
  const criarUsuario = async () => {
    if (!sessionId || !newUserData.name || !newUserData.email) {
      alert('Preencha pelo menos nome e email!')
      return
    }
    
    try {
      setIsLoading(true)
      const timestamp = Date.now()
      const query = `
        const novoUsuario = await prisma.user.create({
          data: {
            name: "${newUserData.name}",
            email: "${newUserData.email}.${timestamp}@exemplo.com",
            bio: "${newUserData.bio || 'Usu√°rio criado via p√°gina de exemplos'}"
          }
        })      console.log('novoUsuario', novoUsuario)
      `
      
      const response = await executeQuery(sessionId, query, true)
      if (response.success) {
        setResult(response.result)
        // Limpar formul√°rio
        setNewUserData({ name: '', email: '', bio: '' })
        // Atualizar lista
        await consultarUsuarios()
        alert('‚úÖ Usu√°rio criado com sucesso!')
      }    } catch (error: any) {
      console.error('‚ùå Erro ao criar usu√°rio:', error)
      setResult({ error: error?.message || 'Erro desconhecido' })
    } finally {
      setIsLoading(false)
    }
  }

  // Buscar usu√°rio por ID
  const buscarUsuarioPorId = async (id: number) => {
    if (!sessionId) return
    
    try {
      setIsLoading(true)
      const query = `
        const usuario = await prisma.user.findUnique({
          where: { id: ${id} },
          include: {
            profile: true,
            posts: true
          }
        })      console.log('usuario', usuario)
      `
      
      const response = await executeQuery(sessionId, query, true)
      if (response.success) {
        setResult(response.result)
      }    } catch (error: any) {
      console.error('‚ùå Erro ao buscar usu√°rio:', error)
      setResult({ error: error?.message || 'Erro desconhecido' })
    } finally {
      setIsLoading(false)
    }
  }
  // Contar usu√°rios
  const contarUsuarios = async () => {
    if (!sessionId) return
    
    try {
      setIsLoading(true)
      const query = `
        const total = await prisma.user.count()      console.log('total', total)
      `
      
      const response = await executeQuery(sessionId, query, true)
      if (response.success) {
        setResult({ totalUsuarios: response.result })
      }    } catch (error: any) {
      console.error('‚ùå Erro ao contar usu√°rios:', error)
      setResult({ error: error?.message || 'Erro desconhecido' })
    } finally {
      setIsLoading(false)
    }
  }

  // Atualizar usu√°rio
  const atualizarUsuario = async (id: number, novaBio: string) => {
    if (!sessionId) return
    
    try {
      setIsLoading(true)
      const query = `
        const usuarioAtualizado = await prisma.user.update({
          where: { id: ${id} },
          data: { 
            bio: "${novaBio}",
            updatedAt: new Date()
          }
        })      console.log('usuarioAtualizado', usuarioAtualizado)
      `
      
      const response = await executeQuery(sessionId, query, true)
      if (response.success) {
        setResult(response.result)
        await consultarUsuarios() // Atualizar lista
        alert('‚úÖ Usu√°rio atualizado com sucesso!')
      }    } catch (error: any) {
      console.error('‚ùå Erro ao atualizar usu√°rio:', error)
      setResult({ error: error?.message || 'Erro desconhecido' })
    } finally {
      setIsLoading(false)
    }
  }

  // Deletar usu√°rio
  const deletarUsuario = async (id: number) => {
    if (!sessionId) return
    
    const confirmacao = confirm(`Tem certeza que deseja deletar o usu√°rio #${id}? Esta a√ß√£o n√£o pode ser desfeita.`)
    if (!confirmacao) return
    
    try {
      setIsLoading(true)
      const query = `
        const usuarioDeletado = await prisma.user.delete({
          where: { id: ${id} }
        })      console.log('usuarioDeletado', usuarioDeletado)
      `
      
      const response = await executeQuery(sessionId, query, true)
      if (response.success) {
        setResult(response.result)
        await consultarUsuarios() // Atualizar lista
        alert('‚úÖ Usu√°rio deletado com sucesso!')
      }    } catch (error: any) {
      console.error('‚ùå Erro ao deletar usu√°rio:', error)
      setResult({ error: error?.message || 'Erro desconhecido' })
    } finally {
      setIsLoading(false)
    }
  }
  return (
    <div style={{ padding: '20px', maxWidth: '1200px', margin: '0 auto' }}>
      <h1>üìö Exemplos - Prisma + Supabase Database</h1>
      <p style={{ marginBottom: '20px', color: '#666', fontSize: '16px', lineHeight: '1.6' }}>
        Esta p√°gina demonstra como usar o <strong>Prisma ORM</strong> para interagir com um database <strong>PostgreSQL do Supabase</strong> em tempo real.
        Aqui voc√™ pode testar queries de consulta, cria√ß√£o, atualiza√ß√£o e busca de dados que aparecer√£o instantaneamente no seu dashboard do Supabase.
      </p>
      <div style={{ 
        padding: '12px', 
        backgroundColor: '#e7f3ff', 
        border: '1px solid #b6d4fe', 
        borderRadius: '5px',
        marginBottom: '30px',
        fontSize: '14px'
      }}>
        <strong>üîó Integra√ß√£o Ativa:</strong> Todos os dados criados aqui s√£o salvos no schema p√∫blico do seu Supabase e podem ser visualizados no dashboard em tempo real.
      </div>

      {/* Status da Sess√£o */}
      <div style={{ 
        padding: '15px', 
        backgroundColor: sessionId ? '#d4edda' : '#f8d7da', 
        border: `1px solid ${sessionId ? '#c3e6cb' : '#f5c6cb'}`,
        borderRadius: '5px',
        marginBottom: '20px'
      }}>
        <strong>Status da Sess√£o:</strong> {sessionId ? `‚úÖ Conectado (${sessionId})` : '‚ùå N√£o conectado'}
        {!sessionId && (
          <button 
            onClick={initSession} 
            disabled={isLoading}
            style={{ marginLeft: '10px', padding: '5px 10px' }}
          >
            Reconectar
          </button>
        )}
      </div>

      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '30px' }}>
        
        {/* Painel de A√ß√µes */}
        <div>
          <h2>üîß A√ß√µes no Database</h2>
          
          {/* Consultar Usu√°rios */}
          <div style={{ marginBottom: '20px', padding: '15px', border: '1px solid #ddd', borderRadius: '5px' }}>
            <h3>üìã Consultar Todos os Usu√°rios</h3>
            <p>Busca todos os usu√°rios do database</p>
            <button 
              onClick={consultarUsuarios} 
              disabled={!sessionId || isLoading}
              style={{ padding: '10px 20px', backgroundColor: '#007bff', color: 'white', border: 'none', borderRadius: '3px' }}
            >
              {isLoading ? 'Consultando...' : 'Consultar Usu√°rios'}
            </button>
          </div>

          {/* Criar Usu√°rio */}
          <div style={{ marginBottom: '20px', padding: '15px', border: '1px solid #ddd', borderRadius: '5px' }}>
            <h3>‚ûï Criar Novo Usu√°rio</h3>
            <div style={{ marginBottom: '10px' }}>
              <input
                type="text"
                placeholder="Nome"
                value={newUserData.name}
                onChange={(e) => setNewUserData({...newUserData, name: e.target.value})}
                style={{ width: '100%', padding: '8px', marginBottom: '8px', border: '1px solid #ccc', borderRadius: '3px' }}
              />
              <input
                type="text"
                placeholder="Email (sem @exemplo.com)"
                value={newUserData.email}
                onChange={(e) => setNewUserData({...newUserData, email: e.target.value})}
                style={{ width: '100%', padding: '8px', marginBottom: '8px', border: '1px solid #ccc', borderRadius: '3px' }}
              />
              <textarea
                placeholder="Bio (opcional)"
                value={newUserData.bio}
                onChange={(e) => setNewUserData({...newUserData, bio: e.target.value})}
                style={{ width: '100%', padding: '8px', marginBottom: '8px', border: '1px solid #ccc', borderRadius: '3px', resize: 'vertical', height: '60px' }}
              />
            </div>
            <button 
              onClick={criarUsuario} 
              disabled={!sessionId || isLoading || !newUserData.name || !newUserData.email}
              style={{ padding: '10px 20px', backgroundColor: '#28a745', color: 'white', border: 'none', borderRadius: '3px' }}
            >
              {isLoading ? 'Criando...' : 'Criar Usu√°rio'}
            </button>
          </div>          {/* Contar Usu√°rios */}
          <div style={{ marginBottom: '20px', padding: '15px', border: '1px solid #ddd', borderRadius: '5px' }}>
            <h3>üìä Contar Usu√°rios</h3>
            <p>Conta o total de usu√°rios no database</p>
            <button 
              onClick={contarUsuarios} 
              disabled={!sessionId || isLoading}
              style={{ padding: '10px 20px', backgroundColor: '#6c757d', color: 'white', border: 'none', borderRadius: '3px' }}
            >
              {isLoading ? 'Contando...' : 'Contar Usu√°rios'}
            </button>
          </div>

          {/* Opera√ß√µes Avan√ßadas */}
          <div style={{ marginBottom: '20px', padding: '15px', border: '1px solid #ddd', borderRadius: '5px', backgroundColor: '#f8f9fa' }}>
            <h3>‚öôÔ∏è Opera√ß√µes Avan√ßadas</h3>
            <p style={{ fontSize: '14px', color: '#666', marginBottom: '15px' }}>
              Para usar estas fun√ß√µes, primeiro consulte os usu√°rios e clique em um para ver os bot√µes de a√ß√£o.
            </p>
            
            <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
              <button 
                onClick={() => {
                  const id = prompt('Digite o ID do usu√°rio para atualizar:')
                  const novaBio = prompt('Digite a nova bio:')
                  if (id && novaBio) atualizarUsuario(parseInt(id), novaBio)
                }}
                disabled={!sessionId || isLoading}
                style={{ padding: '8px 16px', backgroundColor: '#ffc107', color: '#212529', border: 'none', borderRadius: '3px', fontSize: '14px' }}
              >
                ‚úèÔ∏è Atualizar Bio
              </button>
              
              <button 
                onClick={() => {
                  const id = prompt('Digite o ID do usu√°rio para deletar:')
                  if (id) deletarUsuario(parseInt(id))
                }}
                disabled={!sessionId || isLoading}
                style={{ padding: '8px 16px', backgroundColor: '#dc3545', color: 'white', border: 'none', borderRadius: '3px', fontSize: '14px' }}
              >
                üóëÔ∏è Deletar Usu√°rio
              </button>
            </div>
          </div>
        </div>

        {/* Painel de Resultados */}
        <div>
          <h2>üìä Resultados</h2>
            {/* Lista de Usu√°rios */}
          {users.length > 0 && (
            <div style={{ marginBottom: '20px' }}>
              <h3>üë• Usu√°rios Encontrados ({users.length})</h3>
              <div style={{ maxHeight: '300px', overflowY: 'auto', border: '1px solid #ddd', borderRadius: '5px' }}>
                {users.map(user => (
                  <div 
                    key={user.id} 
                    style={{ padding: '10px', borderBottom: '1px solid #eee' }}
                  >
                    <div style={{ marginBottom: '8px' }}>
                      <strong>#{user.id} - {user.name}</strong><br />
                      <small style={{ color: '#666' }}>
                        {user.email}<br />
                        {user.bio && `Bio: ${user.bio}`}
                      </small>
                    </div>
                    
                    <div style={{ display: 'flex', gap: '5px', flexWrap: 'wrap' }}>
                      <button 
                        onClick={() => buscarUsuarioPorId(user.id)}
                        style={{ padding: '4px 8px', backgroundColor: '#17a2b8', color: 'white', border: 'none', borderRadius: '3px', fontSize: '12px' }}
                        title="Ver detalhes completos"
                      >
                        üëÅÔ∏è Detalhes
                      </button>
                      
                      <button 
                        onClick={() => {
                          const novaBio = prompt(`Nova bio para ${user.name}:`, user.bio || '')
                          if (novaBio !== null) atualizarUsuario(user.id, novaBio)
                        }}
                        style={{ padding: '4px 8px', backgroundColor: '#ffc107', color: '#212529', border: 'none', borderRadius: '3px', fontSize: '12px' }}
                        title="Atualizar bio"
                      >
                        ‚úèÔ∏è Editar
                      </button>
                      
                      <button 
                        onClick={() => deletarUsuario(user.id)}
                        style={{ padding: '4px 8px', backgroundColor: '#dc3545', color: 'white', border: 'none', borderRadius: '3px', fontSize: '12px' }}
                        title="Deletar usu√°rio"
                      >
                        üóëÔ∏è Deletar
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Resultado da √öltima Opera√ß√£o */}
          {result && (
            <div>
              <h3>üìù √öltimo Resultado</h3>
              <pre style={{ 
                backgroundColor: '#f8f9fa', 
                padding: '15px', 
                borderRadius: '5px', 
                overflow: 'auto',
                maxHeight: '400px',
                fontSize: '12px',
                border: '1px solid #ddd'
              }}>
                {JSON.stringify(result, null, 2)}
              </pre>
            </div>
          )}
        </div>
      </div>      {/* Dicas */}
      <div style={{ marginTop: '30px', padding: '15px', backgroundColor: '#e7f3ff', border: '1px solid #b6d4fe', borderRadius: '5px' }}>
        <h3>üí° Dicas de Uso</h3>
        <ul>
          <li>‚úÖ <strong>Consultar:</strong> Clique em "Consultar Usu√°rios" para ver todos os dados</li>
          <li>‚ûï <strong>Criar:</strong> Preencha o formul√°rio e clique em "Criar Usu√°rio"</li>
          <li>ÔøΩÔ∏è <strong>Detalhes:</strong> Use o bot√£o "Detalhes" em qualquer usu√°rio para ver informa√ß√µes completas</li>
          <li>‚úèÔ∏è <strong>Editar:</strong> Use o bot√£o "Editar" para atualizar a bio de um usu√°rio</li>
          <li>üóëÔ∏è <strong>Deletar:</strong> Use o bot√£o "Deletar" para remover um usu√°rio (com confirma√ß√£o)</li>
          <li>üìä <strong>Dashboard:</strong> V√° ao seu Supabase para ver os dados em tempo real</li>
          <li>üîÑ <strong>Atualizar:</strong> Os dados s√£o atualizados automaticamente ap√≥s cada a√ß√£o</li>
          <li>‚ö†Ô∏è <strong>Cuidado:</strong> Opera√ß√µes de delete s√£o irrevers√≠veis!</li>
        </ul>
      </div>
    </div>
  )
}